#!/bin/bash -e

INDEX_DIR="/var/lib/scratchpkg/index"
CONF_FILE="/etc/scratchpkg.conf"

source "$CONF_FILE"
source "/usr/share/scratchpkg/color"
source "/usr/share/scratchpkg/message"

if [ ! "$1" ]; then
	msgerr "Please specify package name to list its dependencies."
	exit 1
fi

calcdep() {
	
	dep=$(scratch -d $1 | grep -v "port not exist" | awk '{print $3}')
	for i in $dep; do
		deps="$deps $i"
	done
	
}

loop() {
	
	for depends in ${dep[@]}; do
		if [ "$(echo "$checked" | tr ' ' '\n' | grep -x "$depends")" ]; then
			continue
		else
			checked="$checked $depends"
		fi
		#echo $checked
		calcdep $depends
		loop
	done
}

checkpkg() {
	
	for repo in ${PORT_REPO[@]}; do
		if [ -f $repo/$pkgname/spkgbuild ]; then
			PORT_EXIST=yes
			break
		fi
	done
	if [ ! "$PORT_EXIST" ]; then
		msgerr "Port ${color_red}$pkgname${color_reset} not exist."
		exit 1
	fi
}

start() {
	pkgname=$1

	checkpkg			# check for existence port
	calcdep $pkgname	# calculate dependencies
	loop				# loop through all dependencies

	# filter all same dependencies and sort backwards
	for i in $(echo $deps | tr ' ' '\n'); do
		[ $(echo $filterdep | tr ' ' '\n' | grep -x $i) ] || filterdep="$filterdep $i"
	done

	filterdep="$filterdep $pkgname" # add package to install to final dependency list

}

while [ $1 ]; do
	start $1
	shift
done

for alldep in $(echo $filterdep | tr ' ' '\n'); do
	if [ -d $INDEX_DIR/$alldep ]; then
		echo -e "$alldep ${color_green}[installed]${color_reset}"
	else
		echo "$alldep"
	fi
done

exit 0
